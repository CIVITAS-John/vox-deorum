name: Release Version

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
      dry_run:
        description: 'Dry run (no commits, tags, or releases)'
        required: false
        type: boolean
        default: false

jobs:
  # Build installer and create release
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version files
        id: version
        shell: pwsh
        run: |
          # Read current version
          $versionJson = Get-Content version.json | ConvertFrom-Json
          $major = $versionJson.major
          $minor = $versionJson.minor
          $revision = $versionJson.revision

          # Bump version based on input
          if ("${{ github.event.inputs.version_type }}" -eq "major") {
            $major++
            $minor = 0
            $revision = 0
          } elseif ("${{ github.event.inputs.version_type }}" -eq "minor") {
            $minor++
            $revision = 0
          } elseif ("${{ github.event.inputs.version_type }}" -eq "patch") {
            $revision++
          }

          $version = "v$major.$minor.$revision"
          $versionNoV = "$major.$minor.$revision"
          $installerName = "VoxDeorum-$major.$minor.$revision.exe"

          # Update version.json
          $newVersionJson = @{
            major = $major
            minor = $minor
            revision = $revision
          }
          $newVersionJson | ConvertTo-Json | Set-Content version.json

          # Update release.txt
          $version | Set-Content release.txt

          # Update installer.iss version
          if (Test-Path "scripts\installer.iss") {
            $issContent = Get-Content "scripts\installer.iss" -Raw
            $issContent = $issContent -replace '#define MyAppVersion "[0-9]+\.[0-9]+\.[0-9]+"', "#define MyAppVersion `"$versionNoV`""
            $issContent | Set-Content "scripts\installer.iss" -NoNewline
          }

          # Update README.md version badge if it exists
          if (Select-String -Path "README.md" -Pattern "img.shields.io/badge/version-" -Quiet) {
            $readmeContent = Get-Content "README.md" -Raw
            $readmeContent = $readmeContent -replace "version-v[0-9]+\.[0-9]+\.[0-9]+", "version-$version"
            $readmeContent | Set-Content "README.md" -NoNewline
          }

          # Update bootstrap.cmd with new tag
          if (Test-Path "scripts\bootstrap.cmd") {
            $bootstrapContent = Get-Content "scripts\bootstrap.cmd" -Raw
            $bootstrapContent = $bootstrapContent -replace "defaulting to v[0-9]+\.[0-9]+\.[0-9]+", "defaulting to $version"
            $bootstrapContent | Set-Content "scripts\bootstrap.cmd" -NoNewline
          }

          Write-Host "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "INSTALLER_NAME=$installerName" >> $env:GITHUB_OUTPUT

          Write-Host "Building version: $version"
          Write-Host "Installer will be: $installerName"

      - name: Commit version updates (without pushing)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git add version.json release.txt README.md scripts/bootstrap.cmd scripts/installer.iss
          git commit -m "Release ${{ steps.version.outputs.VERSION }}"

      - name: Install Inno Setup
        run: |
          Write-Host "Downloading Inno Setup 6..."
          $installerPath = "$env:TEMP\innosetup.exe"
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile $installerPath

          Write-Host "Installing Inno Setup 6 silently..."
          Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait

          Write-Host "Inno Setup installed successfully"

      - name: Build installer
        shell: cmd
        run: |
          echo Running build-installer.cmd script...
          cd scripts
          call build-installer.cmd
          echo Build script completed with exit code: %ERRORLEVEL%
          exit /b %ERRORLEVEL%

      - name: Verify installer
        shell: pwsh
        run: |
          # The build script creates the installer in the root dist folder
          $installerPath = "dist\${{ steps.version.outputs.INSTALLER_NAME }}"

          if (Test-Path $installerPath) {
              Write-Host "Installer successfully created at: $installerPath"
              $fileSize = (Get-Item $installerPath).Length / 1MB
              Write-Host "File size: $([math]::Round($fileSize, 2)) MB"
          } else {
              Write-Error "Installer file not found at expected path: $installerPath"
              exit 1
          }

      - name: Get latest commit message
        id: commit_msg
        shell: pwsh
        run: |
          # Get the full commit message (excluding any auto-commits)
          $message = git log -1 --pretty=%B --no-merges

          # Output using GitHub Actions multiline format
          @"
MESSAGE<<EOF
$message
EOF
"@ | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8

      - name: Push commit and tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git push origin main
          git tag -a "${{ steps.version.outputs.VERSION }}" -m "${{ steps.commit_msg.outputs.MESSAGE }}"
          git push origin "${{ steps.version.outputs.VERSION }}"

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: ${{ steps.version.outputs.VERSION }}
          body: |
            ${{ steps.commit_msg.outputs.MESSAGE }}

            ## Quick Install
            Download the installer `${{ steps.version.outputs.INSTALLER_NAME }}` or use `bootstrap.cmd` to automatically set up Vox Deorum.

            ## What's Changed
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.VERSION }}) for detailed changes.
          files: |
            scripts/bootstrap.cmd
            dist/${{ steps.version.outputs.INSTALLER_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        shell: pwsh
        run: |
          Write-Host "=== DRY RUN SUMMARY ==="
          Write-Host "Version: ${{ steps.version.outputs.VERSION }}"
          Write-Host "Installer: ${{ steps.version.outputs.INSTALLER_NAME }}"
          Write-Host ""
          Write-Host "The following changes would be made (but were skipped):"
          Write-Host "- Update version.json, release.txt, README.md, scripts/bootstrap.cmd, and scripts/installer.iss"
          Write-Host "- Commit version updates to main branch"
          Write-Host "- Create and push tag: ${{ steps.version.outputs.VERSION }}"
          Write-Host "- Create GitHub release with installer and bootstrap.cmd"
          Write-Host ""
          Write-Host "Files that would be modified:"
          git diff --name-only
          Write-Host ""
          Write-Host "Version changes:"
          git diff version.json release.txt scripts/installer.iss